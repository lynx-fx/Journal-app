@page "/calendar"
@using JournalApp.Models
@using JournalApp.Services
@inject IJournalsServices JournalsService
@inject NavigationManager NavigationManager

<style>
    .search-container {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 0 4px;
    }
    .search-select {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
    }
    .search-input {
        flex: 1;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #ddd;
        outline: none;
    }
    .search-input:focus {
        border-color: #6200ea;
    }
    .clear-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: #666;
        font-size: 1.2em;
        padding: 0 8px;
    }
</style>

<div class="calendar-container">
    <div class="calendar-header">
        <div class="header-left">
            @if (!IsListView)
            {
                <button class="nav-btn" @onclick="PreviousMonth">‚ùÆ</button>
                <h2 style="display:inline-block; margin:0 12px; width: 160px; text-align:center;">
                    @CurrentMonth.ToString("MMMM yyyy")
                </h2>
                <button class="nav-btn" @onclick="NextMonth">‚ùØ</button>
            }
            else
            {
                <h2>My Journal</h2>
            }
        </div>
        
        <div class="view-toggle">
            <button class="toggle-option @(!IsListView ? "active" : "")" @onclick="() => SetView(false)">Calendar</button>
            <button class="toggle-option @(IsListView ? "active" : "")" @onclick="() => SetView(true)">List</button>
        </div>
    </div>

    @if (IsListView)
    {
        <div class="timeline-view">
            <div class="search-container">
                <select @bind="FilterType" class="search-select">
                    <option value="Content">Content</option>
                    <option value="Tags">Tags</option>
                    <option value="Mood">Mood</option>
                </select>
                <input @bind="SearchQuery" @bind:event="oninput" @onkeyup="HandleSearchInput" placeholder="Search..." class="search-input" />
                @if (!string.IsNullOrWhiteSpace(SearchQuery))
                {
                    <button class="clear-btn" @onclick="ClearSearch">‚úñ</button>
                }
            </div>
            @foreach (var entry in TimelineEntries)
            {
                <div class="timeline-card" @onclick="() => OpenJournal(entry.Date)">
                    <div class="timeline-date">
                        <span class="day">@entry.Date.Day</span>
                        <span class="month">@entry.Date.ToString("MMM")</span>
                    </div>
                    <div class="timeline-content">
                        <div class="timeline-header">
                            <span class="weekday">@entry.Date.DayOfWeek</span>
                            <span class="mood">@GetMoodEmoji(entry.Mood)</span>
                        </div>
                        <div class="timeline-preview">
                            @* Strip HTML for preview *@
                            @(GetPreviewText(entry.Content))
                        </div>
                    </div>
                </div>
            }
            
            @if (!IsSearching)
            {
                <button class="load-more-btn" @onclick="LoadMoreEntries">Load More</button>
            }
        </div>
    }
    else
    {
        <div class="calendar-grid">
            <div class="weekday">Sun</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>

            @for (int i = 0; i < OffsetDays; i++)
            {
                <div class="empty-day"></div>
            }

            @for (int day = 1; day <= DaysInMonth; day++)
            {
                var date = new DateTime(CurrentMonth.Year, CurrentMonth.Month, day);
                var entry = JournalEntries.FirstOrDefault(j => j.Date.Date == date.Date);
                var hasEntry = entry != null;
                var isFuture = date > DateTime.Today;
                
                <div class="day @(hasEntry ? "has-entry" : "") @(IsToday(date) ? "today" : "") @(isFuture ? "future" : "")" 
                     @onclick="() => { if (!isFuture) OpenJournal(date); }">
                    <span class="day-number">@day</span>
                    @if (hasEntry && entry != null)
                    {
                        <span class="mood-indicator">@GetMoodEmoji(entry.Mood)</span>
                    }
                </div>
            }
        </div>
    }
</div>



@code {
    private DateTime CurrentMonth { get; set; } = DateTime.Today;
    private List<Journals> JournalEntries { get; set; } = new List<Journals>();
    private List<Journals> TimelineEntries { get; set; } = new List<Journals>();
    
    private bool IsListView { get; set; } = true;
    private int CurrentPage { get; set; } = 0;
    private const int PageSize = 10;
    
    // Search
    private string SearchQuery { get; set; } = "";
    private string FilterType { get; set; } = "Content";
    private bool IsSearching => !string.IsNullOrWhiteSpace(SearchQuery);

    private async Task HandleSearchInput(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await PerformSearch();
        }
        else if (string.IsNullOrWhiteSpace(SearchQuery))
        {
             // Auto-clear if empty
             await ClearSearch();
        }
    }

    private async Task PerformSearch()
    {
        if (string.IsNullOrWhiteSpace(SearchQuery)) return;

        TimelineEntries = await JournalsService.SearchJournalsAsync(SearchQuery, FilterType);
    }

    private async Task ClearSearch()
    {
        SearchQuery = "";
        CurrentPage = 0;
        TimelineEntries.Clear();
        await LoadEntries(); // Reload initial page
        await LoadMoreEntries(); // Load first batch
    }

    private int DaysInMonth => DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);
    private int OffsetDays => (int)new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1).DayOfWeek;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
        await LoadMoreEntries();
    }

    private async Task LoadEntries()
    {
        JournalEntries = await JournalsService.GetJournalsAsync();
    }
    
    private async Task LoadMoreEntries()
    {
        var newEntries = await JournalsService.GetJournalsAsync(CurrentPage * PageSize, PageSize);
        if (newEntries.Any())
        {
            TimelineEntries.AddRange(newEntries);
            CurrentPage++;
        }
    }

    private void SetView(bool isList)
    {
        IsListView = isList;
    }

    private async Task PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await LoadEntries();
    }

    private async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await LoadEntries();
    }

    private void OpenJournal(DateTime date)
    {
        NavigationManager.NavigateTo($"journal/{date.ToString("yyyy-MM-dd")}");
    }

    private bool IsToday(DateTime date)
    {
        return date.Date == DateTime.Today;
    }

    private string GetMoodEmoji(Moods mood)
    {
        return mood switch
        {
            Moods.Negative => "üòî",
            Moods.Neutral => "üòê",
            Moods.Positive => "üòä",
            _ => "üòê"
        };
    }
    
    private string GetPreviewText(string? htmlContent)
    {
        if (string.IsNullOrWhiteSpace(htmlContent)) return "No content...";
        // Simple strip tags for preview
        return System.Text.RegularExpressions.Regex.Replace(htmlContent, "<.*?>", String.Empty);
    }
}
