@page "/calendar"
@using JournalApp.Models
@using JournalApp.Services
@inject IJournalsServices JournalsService
@inject NavigationManager NavigationManager

<div class="calendar-container">
    <div class="calendar-header">
        <button class="nav-btn" @onclick="PreviousMonth">‚ùÆ</button>
        <h2>@CurrentMonth.ToString("MMMM yyyy")</h2>
        <button class="nav-btn" @onclick="NextMonth">‚ùØ</button>
    </div>

    <div class="calendar-grid">
        <div class="weekday">Sun</div>
        <div class="weekday">Mon</div>
        <div class="weekday">Tue</div>
        <div class="weekday">Wed</div>
        <div class="weekday">Thu</div>
        <div class="weekday">Fri</div>
        <div class="weekday">Sat</div>

        @for (int i = 0; i < OffsetDays; i++)
        {
            <div class="empty-day"></div>
        }

        @for (int day = 1; day <= DaysInMonth; day++)
        {
            var date = new DateTime(CurrentMonth.Year, CurrentMonth.Month, day);
            var entry = JournalEntries.FirstOrDefault(j => j.Date.Date == date.Date);
            var hasEntry = entry != null;
            var isFuture = date > DateTime.Today;
            
            <div class="day @(hasEntry ? "has-entry" : "") @(IsToday(date) ? "today" : "") @(isFuture ? "future" : "")" 
                 @onclick="() => { if (!isFuture) OpenJournal(date); }">
                <span class="day-number">@day</span>
                @if (hasEntry && entry != null)
                {
                    <span class="mood-indicator">@GetMoodEmoji(entry.Mood)</span>
                }
            </div>
        }
    </div>
</div>

<style>
    .calendar-container {
        padding: 0;
        max-width: 100%;
        margin: 0 auto;
    }

    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 0 10px;
    }
    
    .calendar-header h2 {
        font-size: 1.5rem;
        margin: 0;
        color: var(--text-primary);
    }

    .nav-btn {
        background: var(--card-bg);
        border: var(--card-border);
        color: var(--text-primary);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 8px 16px;
        border-radius: 12px;
        transition: all 0.2s;
        box-shadow: var(--card-shadow);
    }
    
    .nav-btn:hover {
        background: var(--primary-color);
        color: var(--nav-active-color);
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 12px;
    }

    .weekday {
        text-align: center;
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
        padding-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .day {
        aspect-ratio: 1;
        background: var(--card-bg);
        border: var(--card-border);
        border-radius: 16px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
        box-shadow: var(--card-shadow);
        color: var(--text-primary); /* Ensure text is visible in dark mode */
    }

    .day:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(0,0,0,0.08);
        border-color: var(--primary-color);
    }

    .day.today {
        border: 2px solid var(--primary-color);
        background: var(--primary-light);
        color: var(--primary-color);
    }

    .day.has-entry {
        background: var(--card-bg); /* Keep card bg, use mood for indicator or border */
    }

    .mood-indicator {
        font-size: 1.2rem;
        margin-top: 4px;
    }

    .day-number {
        font-weight: 600;
        font-size: 1rem;
    }
    
    .day.future {
        opacity: 0.4;
        cursor: not-allowed;
        background-color: transparent !important;
        border: 1px dashed var(--card-border);
        box-shadow: none;
    }
    
    .day.future:hover {
        transform: none;
        box-shadow: none;
        border-color: var(--card-border);
    }
    
    .empty-day {
        /* transparent placeholder */
    }
</style>

@code {
    private DateTime CurrentMonth { get; set; } = DateTime.Today;
    private List<Journals> JournalEntries { get; set; } = new List<Journals>();

    private int DaysInMonth => DateTime.DaysInMonth(CurrentMonth.Year, CurrentMonth.Month);
    private int OffsetDays => (int)new DateTime(CurrentMonth.Year, CurrentMonth.Month, 1).DayOfWeek;

    protected override async Task OnInitializedAsync()
    {
        await LoadEntries();
    }

    private async Task LoadEntries()
    {
        // For simplicity, we are fetching all journals. 
        // In a real app with many years of data, you'd want to filter by month range in the service.
        JournalEntries = await JournalsService.GetJournalsAsync();
    }

    private async Task PreviousMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(-1);
        await LoadEntries(); // Refresh in case we optimize fetching later
    }

    private async Task NextMonth()
    {
        CurrentMonth = CurrentMonth.AddMonths(1);
        await LoadEntries();
    }

    private void OpenJournal(DateTime date)
    {
        NavigationManager.NavigateTo($"journal/{date.ToString("yyyy-MM-dd")}");
    }

    private bool IsToday(DateTime date)
    {
        return date.Date == DateTime.Today;
    }

    private string GetMoodEmoji(Moods mood)
    {
        return mood switch
        {
            Moods.Negative => "üòî",
            Moods.Neutral => "üòê",
            Moods.Positive => "üòä",
            _ => "üòê"
        };
    }
}
